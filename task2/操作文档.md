# task2操作文档

## 任务：

- 用集成脚本一气呵成安装openstack，能够成功打开dashboard，详细操作参考[task1](<https://github.com/2019cloudcomputingpractices/CloudComputingCourse/blob/16340143-%E6%9E%97%E6%A0%91%E5%A5%8E-16340260-%E5%BE%90%E8%BE%BE%E7%83%BD/task1/%E9%83%A8%E7%BD%B2%E6%96%87%E6%A1%A3.md> )
- 虚拟网络设置
- 开启实例



## 具体操作

### 回顾

在task1中已经成功通过集成脚本在虚拟机中完成openstack的安装，并将NAT模式的网卡用于内部网络，所连接的网络为192.168.186.0/24，IP地址为192.168.186.129（通过DHCP服务获得的地址）；Host-Only模式的网卡用于内部网络，所连接的网络为192.168.137.0/24，IP地址为192.168.137.11（通过手动配置的静态IP地址）。



### 准备工作

（1）启动并登录

打开安装好openstack的虚拟机（建议分配给虚拟机的内存为6-8G），openstack相关的服务会在虚拟机启动过程中自动启动。本次实验过程中实测所需内存大概5-6G，以下是实验过程中虚拟机的负载情况。

![虚拟机配置](images/%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%85%8D%E7%BD%AE.png?raw=true)



开机完成后即可在宿主机浏览器中打开Dashboard并登录（即192.168.186.129:8088/horizon），进入主界面。

![主界面](images/%E4%B8%BB%E7%95%8C%E9%9D%A2.png?raw=true)



（2）上传cirros镜像

cirros镜像非常小（11.5MB），是一个非常适合在OpenStack上测试的镜像。它包含linux系统一些基本的功能，安装基本上是开箱即用，运行开销也比较小。我们之后将用它在虚拟机实例上安装系统。

首先点击左侧导航栏管理员菜单中的映像选项，进入镜像管理界面。

![创建映像-0](images/%E5%88%9B%E5%BB%BA%E6%98%A0%E5%83%8F-0.png?raw=true)



点击创建映像按钮弹出对话框，在对话框中输入映像的信息。

![创建映像-1](images/%E5%88%9B%E5%BB%BA%E6%98%A0%E5%83%8F-1.png?raw=true)

![创建映像-2](images/%E5%88%9B%E5%BB%BA%E6%98%A0%E5%83%8F-2.png?raw=true)

创建成功后即可看到新建的镜像的记录。

![创建映像-3](images/%E5%88%9B%E5%BB%BA%E6%98%A0%E5%83%8F-3.png?raw=true)



### 虚拟网络配置

这一个步骤我们将创建一个虚拟的内部网络和外部网络，用于为虚拟机提供通信的环境。

（1）创建内部网络

首先在主页左侧导航栏菜单上打开：管理员->网络，进入网络管理界面。

![创建网络-0](images/%E5%88%9B%E5%BB%BA%E7%BD%91%E7%BB%9C-0.png?raw=true)

点击创建网络，弹出创建网络对话框，输入我们要创建的内部网络的配置信息（如下图）

![创建网络-1](images/%E5%88%9B%E5%BB%BA%E7%BD%91%E7%BB%9C-1.png?raw=true)



其中的分段标识的作用类似于VLAN中用于区分不同子网的VLAN Id。

点击Submit提交信息后成功创建内部网络，并可以看到新建网络的记录。

接着再点击网络列表中我们刚创建好的net1进入网络的编辑界面。然后点击创建子网，弹出创建子网的对话框，这里我们可以指定任意的内网网段（如10.0.0.0-10.255.255.255，172.16.0.0-172.31.255.255，192.168.0.0-192.168.255.255），输入相关信息（如下图）。

注意这里网络IP如果留白，则会把对应网段的第一个ip设为网关，如10.11.12.1，所以后面设置子网的分配池时要避免与网关IP冲突。

![创建内网-子网-1](images/%E5%88%9B%E5%BB%BA%E5%A4%96%E7%BD%91-%E5%AD%90%E7%BD%91-1.png?raw=true)

![创建内网-子网-2](images/%E5%88%9B%E5%BB%BA%E5%A4%96%E7%BD%91-%E5%AD%90%E7%BD%91-2.png?raw=true)

创建成功后即可看到新建子网的记录。

![创建内网-子网-3](images/%E5%88%9B%E5%BB%BA%E5%A4%96%E7%BD%91-%E5%AD%90%E7%BD%91-3.png?raw=true)



（2）检查网络设置

在安装OpenStack时我选用了Host-Only模式的网卡用于外部网络，而Host-Only模式的网络默认无法访问外网，因此我们还需要将宿主机连接了互联网的网络共享给这一网络。

打开网络适配器管理窗口，右键点击宿主机可上网的网卡，选择属性。

![宿主机网络共享-1](images/%E5%AE%BF%E4%B8%BB%E6%9C%BA%E7%BD%91%E7%BB%9C%E5%85%B1%E4%BA%AB-1.png?raw=true)

然后选择共享选项卡，并设置将网络共享给VMnet1

![宿主机网络共享-2](images/%E5%AE%BF%E4%B8%BB%E6%9C%BA%E7%BD%91%E7%BB%9C%E5%85%B1%E4%BA%AB-2.png?raw=true)



点击确认后VMnet1网卡的IP地址便会被设置，我们需要确保VMnet1网卡的IP地址与其所在的子网前缀一致，因此我们打开VMWare的虚拟网络编辑器查看VMnet1所在网络的网段，并取消DHCP服务选项。

![宿主机网络共享-3](images/%E5%AE%BF%E4%B8%BB%E6%9C%BA%E7%BD%91%E7%BB%9C%E5%85%B1%E4%BA%AB-3.png?raw=true)

VMnet1所在网段是192.168.137.0/24，所以我们将宿主机的VMnet1网卡的IP地址设置为192.168.137.1。

![宿主机网络共享-4](images/%E5%AE%BF%E4%B8%BB%E6%9C%BA%E7%BD%91%E7%BB%9C%E5%85%B1%E4%BA%AB-4.png?raw=true)



（3）创建外部网络

接下来返回到网络编辑界面，准备创建一个外部网络，操作流程与上面创建内部网络类似，创建外部网络时输入的配置信息如下：

![创建外网-1](images/%E5%88%9B%E5%BB%BA%E5%A4%96%E7%BD%91-1.png?raw=true)

然后是进入该外部网络的编辑界面创建子网，配置信息如下。注意网关IP与宿主机的VMNet1网卡的IP地址一致，并且关闭DHCP选项，并且网络地址要与VMnet1的网段一致。

![创建外网-子网-2](images/%E5%88%9B%E5%BB%BA%E5%A4%96%E7%BD%91-%E5%AD%90%E7%BD%91-2.png?raw=true)

![创建外网-子网-3](images/%E5%88%9B%E5%BB%BA%E5%A4%96%E7%BD%91-%E5%AD%90%E7%BD%91-3.png?raw=true)



（4）创建路由器

点击左侧导航栏的菜单（项目->网络->路由器），进入路由器设置界面，然后点击创建路由器，弹出对话框，输入路由器信息，如下。

![创建路由器-1](images/%E5%88%9B%E5%BB%BA%E8%B7%AF%E7%94%B1%E5%99%A8-1.png?raw=true)

创建路由器之后点击新建好的路由器进入编辑界面，然后点击接口选项卡，添加接口，子网选择我们上面创建的内部网络net1。添加成功后接口列表中的接口应该处于活动状态。

![创建路由器-2](images/%E5%88%9B%E5%BB%BA%E8%B7%AF%E7%94%B1%E5%99%A8-2.png?raw=true)





### 开启实例

点击左侧导航栏（项目->计算->实例），进入实例管理界面。然后点击启动实例，弹出对话框，填写实例的信息，这里我们选择创建3个实例。配置信息如下：

![创建实例-1](images/%E5%88%9B%E5%BB%BA%E5%AE%9E%E4%BE%8B-1.png?raw=true)

![创建实例-2](images/%E5%88%9B%E5%BB%BA%E5%AE%9E%E4%BE%8B-2.png?raw=true)

![创建实例-3](images/%E5%88%9B%E5%BB%BA%E5%AE%9E%E4%BE%8B-3.png?raw=true)

![创建实例-4](images/%E5%88%9B%E5%BB%BA%E5%AE%9E%E4%BE%8B-4.png?raw=true)

然后点击启动实例，实例将会被创建。点击实例名称即可进入该实例的控制界面，包括控制台，但是Dashboard提供的控制台界面会比较卡顿，在该实例配置好浮动IP之后我们可以使用远程连接工具（如Putty）来连接到虚拟机的终端，这样会流畅很多。



## 小结

本次实验流程中很多的配置都是虚拟化的，非常灵活，特别是网络的配置，这正是得益于网络虚拟化技术。按照传统的方式来搭建网络我们需要借助各种物理设备，如网卡，交换机，路由器等，并做好各个设备的配置（如IP地址，网关，DNS，路由表等）。通过网络虚拟化，网络的创建和配置工作我们能够集中地进行配置，并借助虚拟网卡，虚拟交换机，虚拟路由器等虚拟网络设备搭建我们所需的网络环境。

本次实验中我们所搭建的网络是由底层的网络虚拟设备支持，那么它也有相应的网络拓扑结构，而且Dashboard也已经为我们自动生成了网络的拓扑图（打开左侧菜单栏的"项目->网络->网络拓扑"）！

![网络拓扑](images/%E7%BD%91%E7%BB%9C%E6%8B%93%E6%89%91.png?raw=true)