## 本周具体工作计划

学习以下内容：

- VDI概念解释以及实现原理（个人理解总结、工作流程，如果通过画图来体现，最好自己画图）
- 实现的协议介绍（spice、vnc、rdp），进行对比



## 本周主要工作内容

### i. 已经完成工作

#### 1. VDI概念解释以及实现原理

**1.1 桌面虚拟化**

在了解VDI之前，我们需要先了解一下桌面虚拟化的概念。桌面虚拟化对我们来说其实并不陌生，并且我们正在越来越多地享受着它带来的灵活性和便利性。**桌面虚拟化（Desktop Virtualization）**是一种软件技术，它对桌面环境和相关应用程序软件与用于访问它的物理客户端进行隔离。我们经常用到的云桌面便是桌面虚拟化的应用。云桌面使我们能够通过网络在不同的地方不同的终端（如PC，笔记本甚至手机）上访问到一个我们想要的桌面环境（如一个win10桌面环境），并可以使用上面的应用程序，且该桌面环境与我们的终端是隔离的，在云桌面中的操作并不会影响到我们的终端。

**1.2 VDI**

桌面虚拟化的实现有多种方式，目前主要有三种架构实现，而**VDI（Virtual Desktop Infrastructure）**，即虚拟桌面基础架构，它是桌面虚拟化的其中一种架构实现。另外两种实现为**IDV（Intelligent Desktop Virtualization），即智能桌面虚拟化**和**VOI（Virtual OS Infrastructure）**。

以下是这三种实现的简单对比：

| 架构    | 特点                                                         |
| ------- | ------------------------------------------------------------ |
| VDI架构 | “集中计算，集中管理”，虚拟桌面集中运行在数据中心上的服务器   |
| IDV架构 | “分布式计算，集中管理”，虚拟桌面使用终端的计算资源           |
| VOI架构 | 对操作系统存储层进行重新定向，是改进的无盘工作站方案，其最大特点是管理集中化，性能体验好 |



**1.3 VDI实现原理**

VDI的实现使用的是“集中计算，集中管理”的模式。所有的虚拟桌面都运行在数据中心的服务器上，通常来说一个虚拟机实例可以对应一个或多个桌面实例，虚拟机的运行和管理和镜像管理等相关服务可由openstack平台提供。桌面实例的数据也都存储在数据中心，而不存储在终端上，这能够较好的保障数据安全性，适用于对数据有较严格保护需求的场景。

用户对虚拟桌面的使用借助于网络通信，远程访问协议（如vnc，rdp，spice）及相应的客户端。用户可以在不同地方不同设备上（如PC，甚至是移动设备）使用虚拟桌面，只要有网络连接以及安装了相应的客户端。客户端通过远程访问协议将用户的鼠标操作以及键盘输入的数据传输到数据中心的服务器上，服务器将这些数据传递给相应的虚拟机实例，虚拟机实例对这些鼠标操作和键盘输入进行响应，响应后的结果将通过远程访问协议传回客户端，客户端便能显示出操作后的结果。这个过程使得用户在客户端上操作虚拟桌面就像是在使用真实的桌面一样，但体验比较受限于网络传输的延迟。  

管理员则可以对数据中心上的镜像及运行的桌面实例进行集中管理，如监控桌面的状态，计算资源的分配，镜像的更换等。



#### 2. VNC、Spice、RDP协议介绍和对比

**2.1 VNC**

**VNC（Virtual Network Computing）**为一种使用RFB协议的屏幕画面分享及远程操作软件。此软件借由网络，可发送键盘与鼠标的动作及即时的屏幕画面。 VNC与操作系统无关，因此可以跨平台使用，例如可用windows连接到linux的计算机，反之亦同。

VNC系统包含客户端，服务端和协议这三部分。VNC的服务段负责分享其所运行机器的屏幕，服务端被动地允许客户端控制它。VNC客户端观察控制服务端，与服务端交互。VNC协议Protocol（RFB）是一个简单的协议，传送服务端的原始图像到客户端，客户端传送事件消息到服务端。这样的工作方式使得VNC具有了操作系统无关性，对于任何的桌面操作系统，VNC可以用同样的方式传输原始图像和事件消息，而无需传送特定于操作系统的数据或具有特定于操作系统的行为。

但直接传输一帧一帧的原始图像明显是一种比较低效的方法，会消耗很多带宽。因此VNC使用了多种方法来减少带宽的使用量，例如每次传送桌面的图像时只传送服务端屏幕发生变化区域的图像，这样在帧间屏幕变化较小的情况便可以大大减小带宽的使用，在其他情况下则效率提升效果有限，因此也有许多其他的编码被设计出来用于VNC协议中。



**2.2 spice**

**SPICE（Simple Protocol for Independent Computing Environment）协议**，即独立计算环境简单协议，是Red Hat企业虚拟化桌面版的主要技术组件之一，具有自适应能力的远程提交协议。SPICE开源且支持跨平台，且支持外接设备，例如支持远程使用打印机和扫描仪等设备。

Spice 包含四个部分：协议、客户端侧、服务端侧和虚拟机侧。其中，

（1）协议：是客户端侧、服务端侧和虚拟机侧三个部分交互时所遵循的准则；

（2）客户端：负责接收并转换虚拟机数据，以及发送用户输入数据到虚拟机，从而使得用户能够与虚拟机进行交互；

（3）服务端：是集成在Hypervisor内部的一个用户层组件，使得Hypervisor（如QEMU）支持Spice协议；

（4）虚拟机侧：指所有部署在虚拟机内部的必需组件，如QXL驱动、Spice Agent等。

SPICE协议的工作原理明显不同于VNC，SPICE借助QEMU提供的接口以及虚拟机内部的QXL驱动能够获取到虚拟机内部的应用程序更新画面所使用的命令流用于让客户端更新画面，也能将客户端对桌面执行的操作对应的命令流传送到虚拟机内部执行。因此客户端与服务端之间所需传输的数据量将大大减小，使用上将更加流畅。



**2.3 RDP**

**RDP（Remote Desktop Protocol）**，远程桌面协议，是一个多通道（multi-channel）的协议，让用户（客户端或称“本地电脑”）连上提供微软终端机服务的电脑（服务器端或称“远程电脑”）。大部分的Windows、Linux、FreeBSD、Mac OS X都有相应的客户端。

RDP协议分为多个层次，不同层次负责提供不同的服务： 

（1）**网络连接层：**RDP协议建立在TCP/IP协议之上，由于传输的数据量比较大，因此在协议的底层首先定义一层网络连接层。它定义了一个完整的RDP数据逻辑包，以避免由于网络包长度过长而被分割使数据丢失。     

 （2）**ISO数据层：**在网络连接层之上是ISO数据层，它表示RDP数据的正常连接通信。      

（3）**虚拟通道层：**在ISO数据层之上，RDP协议定义一个虚拟通道层，用以拆分标示不同虚拟通道的数据，加快客户端处理速度，节省占用网络接口的时间。      

（4）**加密解密层：**在虚拟通道层之上，RDP定义一个数据加密解密层。此层用于对所有的功能数据进行加密、解密处理。      

（5）**功能数据层：**在加密解密层之上是功能数据，画面信息，本地资源转换，声音数据，打印数据等所有的功能数据信息都在此层进行处理。



**2.4 对比**

以下是对于SPICE、VNC、RDP三种协议更细致的对比。

|              | SPICE                     | VNC          | RDP                 |
| ------------ | ------------------------- | ------------ | ------------------- |
| BIOS屏幕显示 | 能                        | 能           | 不能                |
| 全彩支持     | 能                        | 能           | 能                  |
| 更改分辨率   | 能                        | 能           | 能                  |
| 多显示器     | 多显示器支持（高达4画面） | 只有一个屏幕 | 多显示器支持        |
| 图像传输     | 图像和图形传输            | 图像传输     | 图像和图形传输      |
| 视频播放支持 | GPU加速支持               | 不能         | GPU加速支持         |
| 音频传输     | 双向语音可以控制          | 不能         | 双向语音可以控制    |
| 鼠标控制     | 客户端服务器都可以控制    | 服务器端控制 | 服务器端控制        |
| USB传输      | USB可以通过网络传输       | 不能         | USB可以通过网络传输 |



参考资料：

[wiki Desktop Virtualization](<https://en.wikipedia.org/wiki/Desktop_virtualization#System_architectures> )

[Spice协议初探](<https://zhuanlan.zhihu.com/p/31683928> )

[远程桌面协议浅析（VNC/SPICE/RDP）](<https://blog.csdn.net/wait_for_taht_day5/article/details/51396823> )

[RDP协议详解](<https://blog.csdn.net/songshiMVP1/article/details/46441929> )



### ii. 未完成工作

无



### iii. 问题与困难

不少关于VDI的文章说的比较笼统易于让人混淆，通过对比和参考多篇文章比较能够清晰地理解VDI的概念及相关的其他概念（如桌面虚拟化，IDV，VOI）



## 下周工作计划

整理对目前所学的云计算和虚拟化技术的概念的理解，如镜像，快照，kvm，qemu，虚拟桌面技术等，并将它们联系起来。



## 建议与意见

无