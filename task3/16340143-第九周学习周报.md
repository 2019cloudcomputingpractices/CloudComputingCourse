## 本周具体工作计划

学习常见镜像格式及其区别、为什么需要自制镜像、镜像制作的流程、openstack 镜像相关命令

## 本周主要工作内容

### i. 已经完成工作

#### 1. 常见镜像格式及其区别

虚拟机镜像的格式主要有：raw，cow，qcow，qcow2，vmdk，vdi。不同的镜像格式对磁盘空间的占用，性能，功能等方面有不同的表现

（1）**raw** ：raw格式的镜像有如下几个特点： 原始的二进制格式，可以通过dd命令直接创建；读取速度最快（但占用空间也大）；能够被宿主机直接挂载。其缺点主要是：不支持snapshot快照、不支持磁盘压缩、AES加密等。

（2）**cow（copy-on-write format）**：曾经qemu的写时拷贝的镜像格式，目前由于历史遗留原因不支持窗口模式，后来被qcow格式所取代。

（3）**qcow（the old QEMU copy-on-write format）**：新一代的qemu的cow格式，刚刚出现的时候有比较好的特性，但其性能和raw格式相比还是有比较大的差距，目前已经被新版本的qcow2取代。

（4）**qcow2（QEMU copy-on-write format）****：现在比较主流的一种虚拟化镜像格式，经过一代的优化，目前qcow2的性能接近raw格式的性能。qcow2主要有以下特点：

- 更小的存储空间，即使是不支持holes的文件系统也可以
- 写时复制特性
- 支持多个snapshot，对历史snapshot进行管理
- 支持zlib的磁盘压缩
- 支持AES加密

（5）**vmdk**：VMware使用的格式

（6）**vdi**：VirtualBox使用的格式



#### 2. 为何需要自制镜像

自制镜像通常可以用来实现快速的环境配置，实现环境开箱即用的效果。在自制镜像过程中预先配置好所需的环境，制作成镜像之后便可以用于启动新的具有同样环境配置的实例。另外，自制镜像也可以用于备份。



#### 3. 镜像制作的流程

下面介绍使用qemu-img、virsh、virt-iinstall制作镜像并在openstack中使用镜像创建并启动实例的过程。假设openstack已经在服务器上部署成功。

（1）准备qemu-img、virsh、virt-install：一般来说qemu-img、virsh在安装openstack时也会被安装，可能需要安装的是virt-install，可用如下命令安装：

```bash
$sudo apt-get install virtinst
```

（2）检查virt是否有default网络，若无则创建

（3）使用qemu-img创建镜像文件

（4）通过virt-install创建虚拟机，将选定的操作系统安装到创建好的镜像上

（5）进入虚拟机配置所需的环境或者写入所需的数据

（6）关闭虚拟机并通过openstack提供的相关命令上传镜像

（7）在openstack上创建并启动实例



#### 4. openstack镜像相关命令

列出可以访问的镜像

```bash
$ openstack image list
```

删除指定的镜像

```bash
$ openstack image delete IMAGE
```

描述一个指定的镜像

```bash
$ openstack image show IMAGE
```

更新镜像

```bash
$ openstack image set IMAGE
```

上传内核镜像

```bash
$ openstack image create "cirrors-threepart-kernel" \
  --disk-format aki --container-format aki --public \
  --file ~/image/cirros-0.3.5-x86_64-kernel
```

上传RAM镜像

```bash
$ openstack image create "cirros-threepart-ramdisk" \
  --disk-format ari --container-format ari --public \
  --file ~/image/cirros-0.3.5-x86_64-initramfs
```

上传第三方镜像

```
$ openstack image create "cirros-threepart" --disk-format ami \
  --container-format ami --public \
  --property kernel_id=$KID-property ramdisk_id=$RID \
  --file ~/images/cirros-0.3.5-x86_64-rootfs.img
```



### ii. 未完成工作

无



### iii. 问题与困难

网上关于各种镜像格式的详细介绍的资料比较少



## 下周工作计划

加深对相关虚拟化技术的理解，如qemu，kvm，学习openstack的更多使用方法



## 建议与意见

无